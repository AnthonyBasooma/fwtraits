---
title: "How to handle the API key in public and private codes."
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to handle the API key in public and private codes.}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(fwtraits)
library(httr2)
```

## 1. API key used in private codes.

1. Acquire the API key, the user can follow the steps elucidated in **`fw_be4ustart()`** function.

2. Copy the API key beforehand.

3. Provide the seed parameter in the **`fw_token()`** function and execute. A pop up will appear and paste in the copied API key in step 2.

4. A token will be automatically generated, which will be used in all the queries.

Note: Even for private codes, dont share the key in the codes.

```{r}

#apikey <-  '36 character code provided during registration'

#tokendata <- fw_token(seed = 1122)# the seed is digit used to cache the data.

```



## 2. Public codes sharing and use

```{r}

#step 1: Generate a secret key using httr2:make_secret_key() function

secretkey <- secret_make_key() #secret key automatically generated will be saved in the r environment

#step 2: setting the FWTRAITS_KEY where to save the secretkey

#run this usethis::edit_r_environ()

#which open the r environment and type in
#FWTRAITS_KEY = 'enter secretkey string generated in step 1'
#the FWTRAITS_KEY is the unlock key saved in my local environment

#step3: Use the secret key to scramble the API key

#scrambled_api_key <- secret_encrypt(apikey, secretkey)


#encrypted token for api key

#step 4: use the scrambled api key in the public codes:

#steps 1 and 2 are not included in the codes but rather the output scrambled_key
#generated in step 2 is used


```

### Use scrambled API key to retrieve data from freshwaterecology.info database.

```{r}

sacrambled_api <- "p6-9gAvYXveyC_B_0hTzyYl5FwLRwZEPD-ZE9Y4KrIBstgNc8K2Mr4u6t39LGZ2E1m9SOw"
#scrambled_api_key

#Download fish catchment region data

apikeydecrypted <- fw_loadapikey(test = TRUE, sacrambled_apikey = sacrambled_api,
                              fwtraitskey =  'FWTRAITS_KEY')

tokendata <- fw_token(apikey= apikeydecrypted, seed = 1234, cachepath = 'cache')

fishdata <- fw_fetchdata(data = 'Abramis brmaam', organismgroup = 'fi',
                             ecoparams = 'catchment region',
                             token = tokendata,
                         cachepath = 'cache')#the species spelling is checked

```


## 3. References

1. Wickham H (2024). _httr2: Perform HTTP Requests and Process the Responses_. R package version 1.0.3,<https://CRAN.R-project.org/package=httr2>

2. https://httr2.r-lib.org/articles/wrapping-apis.html












