---
title: "Acessing macroinvertebrates data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Acessing macroinvertebrates data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(httr2)
library(fwtraits)
```

###Step 1: Get the before you start page for instructions on how to access the database.

To ably set the API key and obtain the token, check the secure_api_key.html vignettes. Briefly, they are two ways to set the API key: 1) in private user codes and 2) public/shared codes. Since in the vignettes the codes are shared, the API key willl be encryted and decrypted on querying the database.

```{r beforeyoure start procedure}
#fw_be4ustart()
```

###Step 2: Get authentication token through the API key.

```{r generate token}

enc_api <- "p6-9gAvYXveyC_B_0hTzyYl5FwLRwZEPD-ZE9Y4KrIBstgNc8K2Mr4u6t39LGZ2E1m9SOw"

#download macroinvertebrates data

apikeydecrypted <- fw_loadapikey(test = TRUE, 
                                 sacrambled_apikey = enc_api,
                              fwtraitskey =  'FWTRAITS_KEY')

tokendata <- fw_token(apikey= apikeydecrypted, seed = 1234, cachepath = 'cache')

```

###Step3: Access the macroinvertebrates traits data

* **NOTE**: Before accessing the species ecological preferences, all the indicates traits data will first be downloaded even if one species is indicated. But after, the data will be loaded from computer memory for the proceeding queries. 

```{r access species ecological traits}

#One species 

mmdata_traits <- fw_fetchdata(data =  "Margaritifera margaritifera",
                            organismgroup = 'mi',
                            ecoparams = c('stream zonation preference'),
                            token = tokendata,
                            inform = TRUE,
                            cachepath = 'cache')

#for more than one species in a list 

specieslist <- c("Margaritifera margaritifera",
                 "Pseudunio auricularius",
                 "Musculium lacustre",
                 "Musculium transversum",
                 "Parastenocaris germanica")

multspp <- fw_fetchdata(data =  specieslist,
                            organismgroup = 'mi',
                            ecoparams = c('stream zonation preference'),
                            token = tokendata,
                        inform = TRUE,
                        sanitize = TRUE,
                        cachepath = 'cache')

#species in a data frame 

macrodf <- data.frame(organismgroup = rep('mi', 5),
                      species = c("Margaritifera margaritifera",
                 "Pseudunio auricularius",
                 "Musculium lacustre",
                 "Musculium transversum",
                 "Parastenocaris germaica"))

multspp_df <- fw_fetchdata(data =  macrodf,
                            organismgroup = 'mi',
                           spcol = 'species',
                            ecoparams = c('stream zonation preference'),
                            token = tokendata,
                        inform = TRUE,
                        sanitize = TRUE,
                        cachepath = 'cache')

```

###Step4. Visualize extracted outputs

```{r viszualize outputs, fig.width = 6, fig.height= 5, fig.align='center'}

#fw_visualize(foutput = mmdata_traits)# not necessary since its one species

fw_visualize(output = multspp)

fw_visualize(output = multspp_df)

```

**References**
* Schmidt-Kloiber, A., & Hering, D. (2015). www.freshwaterecology.info - An online tool that unifies, standardises and codifies more than 20,000 European freshwater organisms and their ecological preferences. Ecological Indicators, 53, 271-282. https://doi.org/10.1016/j.ecolind.2015.02.007

